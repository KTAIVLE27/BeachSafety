{% extends "base/base.html" %}
{% load static %}

{% block title %}모의훈련{% endblock %}

{% block sidebar_brand %}
<a class="navbar-brand mx-4 mb-3">
    <h3 class="text-primary">모의훈련</h3>
</a>
{% endblock %}

{% block content %}
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #e8f0fe;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .chat-window {
        border: 1px solid #003366;
        border-radius: 10px;
        background-color: #fff;
        overflow: hidden;
        padding: 0;
    }

    .chat-header {
        background-color: #003366;
        color: #fff;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-bottom: 1px solid #002244;
        margin: 0;
    }

    .chat-box {
        display: flex;
        flex-direction: column;
        height: 500px;
    }

    .chat-body {
        flex-grow: 1;
        overflow-y: auto;
        background-color: #f0f8ff;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .chat-message {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        background-color: #d1e7ff;
        padding: 8px 12px;
        border-radius: 5px;
        color: #003366;
    }

    .chat-message.user {
        align-self: flex-end;
        background-color: #cce5ff;
        color: #003366;
    }

    .button-group {
        display: flex;
        gap: 5px;
        flex-wrap: nowrap;
        justify-content: space-evenly;
        align-content: flex-start;
        align-items: flex-start;
    }

    .chat-footer {
        display: flex;
        gap: 5px;
    }

    .chat-footer input {
        flex-grow: 1;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .chat-footer button {
        background-color: #003366;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .loading-spinner {
        display: none;
        width: 3rem;
        height: 3rem;
        border: 0.5rem solid #f3f3f3;
        border-top: 0.5rem solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    /* 전체 채팅 박스 스타일 */
.chat-box {
    background-color: #f9f9f9; /* 채팅창 배경색 */
    border-radius: 10px; /* 둥근 모서리 */
    border: 1px solid #e0e0e0; /* 얇은 테두리 */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* 부드러운 그림자 */
    overflow: hidden;
    height: calc(100% - 50px); /* 버튼과 입력창을 제외한 높이 */
    display: flex;
    flex-direction: column;
}

/* 채팅 내용 스타일 */
#chat-content {
    padding: 10px;
    overflow-y: auto; /* 스크롤이 필요할 때만 나타나도록 */
    flex: 1; /* 내용이 가능한 공간을 모두 차지하도록 */
}

/* 채팅 메시지 박스 스타일 */
.chat-message {
    display: flex;
    align-items: flex-start; /* 메시지 박스가 위쪽에 정렬되도록 설정 */
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 5px;
    color: #003366;
    max-width: 60%; /* 메시지 박스의 최대 너비 설정 */
    word-break: break-word; /* 긴 단어를 줄 바꿈 */
}

/* 사용자 메시지 스타일 (오른쪽 정렬) */
.chat-message.user {
    background-color: #d1e7ff; /* 사용자 메시지 배경색 */
    align-self: flex-end; /* 메시지를 오른쪽으로 정렬 */
    border-bottom-right-radius: 0; /* 오른쪽 아래 모서리 각도 0으로 설정 */
}

/* 상대방 메시지 스타일 (왼쪽 정렬) */
.chat-message.other {
    background-color: #ffffff; /* 상대방 메시지 배경색 */
    align-self: flex-start; /* 메시지를 왼쪽으로 정렬 */
    border-bottom-left-radius: 0; /* 왼쪽 아래 모서리 각도 0으로 설정 */
}

/* 입력창과 버튼 그룹 */
.input-group {
    padding: 10px;
    background-color: #ffffff; /* 입력창과 버튼 배경색 */
    border-top: 1px solid #e0e0e0; /* 상단 테두리 */
    box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.1); /* 하단 그림자 */
    display: flex;
    align-items: center;
}

/* 입력창 스타일 */
#question-input {
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 10px;
    font-size: 14px;
    flex: 1; /* 입력창이 가능한 공간을 모두 차지하도록 */
    margin-right: 10px; /* 입력창과 버튼 사이에 여백 추가 */
}

/* 전송 버튼 스타일 */
#send-button {
    background-color: #003366; /* 버튼 배경색 */
    border: none;
    border-radius: px;
    color: #ffffff;
    padding: 10px 20px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

/* 전송 버튼 호버 효과 */
#send-button:hover {
    background-color: #0056b3; /* 버튼 호버 색상 */
}

/* 버튼 그룹 스타일 */
.button-group {
    display: flex;
    flex-wrap: wrap; /* 화면 크기에 따라 자동으로 줄 바꿈 */
    gap: 10px; /* 버튼 간의 간격 */
    margin-top: 20px;
    padding: 10px;
}

.btn-custom {
    background-color: #003366; /* 버튼 배경색 */
    color: #ffffff; /* 버튼 글자색 */
    border: none; /* 테두리 없음 */
    border-radius: 5px; /* 둥근 모서리 */
    padding: 10px 15px; /* 버튼 내부 여백 */
    font-size: 14px; /* 글자 크기 */
    cursor: pointer; /* 마우스 커서가 포인터로 변경 */
    transition: background-color 0.3s ease; /* 배경색 변화 애니메이션 */
}


/* 버튼 기본 스타일 */
.button-group .btn-custom {
    background-color: #003366; /* 버튼 배경색 */
    color: #ffffff; /* 버튼 텍스트 색상 */
    border: none; /* 기본 테두리 없음 */
    border-radius: 13px; /* 둥근 모서리 */
    padding: 10px 20px; /* 버튼의 여백 */
    font-size: 14px; /* 버튼 텍스트 크기 */
    cursor: pointer; /* 커서 모양 변경 */
    transition: background-color 0.3s, transform 0.2s; /* 배경색과 변형 효과에 대한 트랜지션 */
    margin-bottom: 10px; /* 버튼 하단 여백 */
}

/* 버튼 호버 스타일 */
.button-group .btn-custom:hover {
    background-color: #002244; /* 버튼 호버 배경색 */
    transform: translateY(-2px); /* 호버 시 살짝 떠오르는 효과 */
}

/* 버튼 활성화 스타일 (선택적) */
.button-group .btn-custom:active {
    background-color: #001a33; /* 버튼 클릭 시 배경색 */
    transform: translateY(0); /* 클릭 시 위치 유지 */
}

</style>
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-lg-12">
            <div class="bg-light text-center rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h2 class="mb-0">모의 훈련</h2><hr>
                </div>
<!-- Main Content Start -->
<div class="container-fluid pt-4 px-4" id='contentbox-1'>
    <div class="row" id='contentbox-2'>
        <!-- Chat Box Start -->
        <div class="col-sm-12 col-md-6 mb-4">
            <div class="bg-light text-center rounded p-4 h-100 chat-window">
                <h4 class="mb-4 chat-header">해양안전 시나리오 챗봇</h4>
                <div class="chat-box" id='contentbox-3'>
                    <div id="chat-content" class="chat-body">
                        <!-- Initial welcome message -->
                        <div class="chat-message">
                            <strong>안녕하세요 해양안전 AI 모니터링 시스템입니다</strong>
                        </div>
                        <!-- {% for log in logs %}
                        <div class="chat-message-box">
                            <strong>질문:</strong> {{ log.question|safe }}<br>
                            <strong>답변:</strong><br>
                            {{ log.answer|safe|linebreaksbr }}
                        </div>
                        {% endfor %} -->
                    </div>
                    <div class="loading-spinner" id="loading-spinner"></div>
                    <div class="button-group mt-3">
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('생물 보호')">생물보호</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('수상레저')">수상레저</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('불법')">불법</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('해양오염')">해양오염</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('피서객 안전')">피서객 안전</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('익수자')">익수자</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('의료지원')">의료지원</button>
                        <button class="btn-custom" onclick="sendRandomPredefinedQuestion('실종')">실종</button>
                    </div>
                    <div class="input-group mt-3 chat-footer">
                        <input type="text" class="form-control" id="question-input" placeholder="메시지 입력" onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" id="send-button" onclick="sendMessage()">전송</button>
                    </div>
                </div>
                <div class="loading-spinner" id="loading-spinner"></div>
            </div>
        </div>
        <!-- Chat Box End -->

<style>
    .bg-light.text-center.rounded.p-4.h-100 {
        border: 2px solid #003366; /* 청색 테두리 추가 */
    }    

    .evaluation-box {
        background-color: #003366; /* 배경색 */
        border-radius: 10px; /* 둥근 모서리 */
        border: 1px solid #003366; /* 청색 테두리 */
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* 부드러운 그림자 */
        display: flex;
        flex-direction: column;
        gap: 20px; /* 섹션 간의 간격 */
        color: #000000; /* 글자색 */
    }
    
    .form-group {
        background-color: #ffffff; /* 타이머 섹션 배경색 */
        border: 3px solid #034e98; /* 섹션 테두리 색 */
        border-radius: 5px; /* 둥근 모서리 */
        padding: 15px; /* 내부 여백 */
        margin-bottom: 10px; /* 섹션 간 간격 */
    }
    
    .form-group:last-child {
        background-color: #fffd98; /* 총 훈련 시간 섹션 배경색 */
        border: 1px solid #600101; /* 총 훈련 시간 섹션 테두리 색 */
        padding: 20px;
    }
    
    .stopwatch {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #666666; /* 글자색 */
    }
    
    .record {
        font-size: 14px;
        color: #ff0000; /* 기록 글자색 */
    }
    
    .btn-start, .btn-stop {
        font-size: 14px; /* 버튼 글자 크기 */
        padding: 8px 12px; /* 버튼 내부 여백 */
        border-radius: 5px; /* 둥근 모서리 */
        margin-right: 5px; /* 버튼 간 간격 */
        border: none; /* 버튼 테두리 없음 */
    }
    
    .btn-start {
        background-color: #003366; /* 시작 버튼 배경색 */
        color: #ffffff; /* 버튼 글자색 */
    }
    
    .btn-stop {
        background-color: #ff0000; /* 정지 버튼 배경색 */
        color: #ffffff; /* 버튼 글자색 */
    }
    
    .btn-start:hover {
        background-color: #3e5e7d; /* 마우스 호버 시 배경색 변경 */
    }
    
    .btn-stop:hover {
        background-color: #d54747; /* 마우스 호버 시 배경색 변경 */
    }
    
    /* 강조된 총 훈련 시간 섹션 스타일 */
    .final-time-section {
        background-color: #0066cc; /* 총 훈련 시간 강조 색 */
        border: 1px solid #005bb5; /* 강조 색 테두리 */
        padding: 20px;
        border-radius: 10px;
    }
    
    .final-time-section h6 {
        font-size: 18px;
        font-weight: bold;
    }
    
    .final-time-section .stopwatch {
        font-size: 32px; /* 총 시간 큰 글씨 */
    }
    
    .final-time-section .btn {
        font-size: 16px; /* 버튼 글자 크기 */
        padding: 10px 15px; /* 버튼 내부 여백 */
    }
    
    
    /* 레이블 스타일 */
    .form-label {
        color: #ffffff; /* 레이블 텍스트 색상 */
        font-size: 18px; /* 레이블 텍스트 크기 */
        margin-bottom: 5px;
    }
    
</style>
<!-- Evaluation Box Start -->
<div class="col-sm-12 col-md-6 mb-4">
    <div class="bg-light text-center rounded p-4 h-100">
        <h4 class="mb-4">평가 항목</h4>
        <div class="evaluation-box" id='contentbox-4'>
            <div class="form-group mb-3">
                <label for="stopwatch1">상황 전파 및 출동 준비</label>
                <div id="stopwatch1" class="stopwatch">00:00:00.000</div>
                <button class="btn btn-start mt-2" onclick="startStopwatch(0)">Start</button>
                <button class="btn btn-stop mt-2" onclick="stopStopwatch(0)">Stop</button>
                <div id="record1" class="record mt-2"></div>
            </div>
            <div class="form-group mb-3">
                <label for="stopwatch2">구조 활동 시간</label>
                <div id="stopwatch2" class="stopwatch">00:00:00.000</div>
                <button class="btn btn-start mt-2" onclick="startStopwatch(1)">Start</button>
                <button class="btn btn-stop mt-2" onclick="stopStopwatch(1)">Stop</button>
                <div id="record2" class="record mt-2"></div>
            </div>
            <div class="form-group mb-3">
                <label for="stopwatch3">상황 마무리 및 인수 인계</label>
                <div id="stopwatch3" class="stopwatch">00:00:00.000</div>
                <button class="btn btn-start mt-2" onclick="startStopwatch(2)">Start</button>
                <button class="btn btn-stop mt-2" onclick="stopStopwatch(2)">Stop</button>
                <div id="record3" class="record mt-2"></div>
            </div>
            <div class="form-group final-time-section mb-3">
                <h6 class="mb-4">총 훈련 소요 시간</h6>
                <div id="finalStopwatch" class="stopwatch">00:00:00.000</div>
                <button class="btn btn-success mt-2" onclick="showFinalTime()">최종 시간 보기</button>
                <button class="btn btn-danger mt-2" onclick="resetAllStopwatches()">초기화</button>
            </div>
        </div>
    </div>
</div>

<!-- Evaluation Box End -->
    </div>
</div>
<!-- Main Content End -->
</div></div></div></div>

<script>
    var stopwatches = [0, 0, 0];
    var intervals = [null, null, null];
    var finalTime = 0;

    function startStopwatch(index) {
        if (intervals[index] === null) {
            intervals[index] = setInterval(function() {
                stopwatches[index] += 10;
                document.getElementById('stopwatch' + (index + 1)).innerText = formatTime(stopwatches[index]);
            }, 10);
        }
    }

    function stopStopwatch(index) {
        if (intervals[index] !== null) {
            clearInterval(intervals[index]);
            intervals[index] = null;
            document.getElementById('record' + (index + 1)).innerText = "기록: " + formatTime(stopwatches[index]);
            finalTime += stopwatches[index];
        }
    }

    function resetStopwatch(index) {
        if (intervals[index] !== null) {
            clearInterval(intervals[index]);
            intervals[index] = null;
        }
        stopwatches[index] = 0;
        document.getElementById('stopwatch' + (index + 1)).innerText = "00:00:00.000";
        document.getElementById('record' + (index + 1)).innerText = "";
    }

    function resetAllStopwatches() {
        for (var i = 0; i < 3; i++) {
            resetStopwatch(i);
        }
        finalTime = 0;
        document.getElementById('finalStopwatch').innerText = "00:00:00.000";
        document.getElementById('largeFinalTime').innerText = "00:00:00.000";
    }

    function showFinalTime() {
        var formattedTime = formatTime(finalTime);
        document.getElementById('finalStopwatch').innerText = "최종 시간: " + formattedTime;
        document.getElementById('largeFinalTime').innerText = formattedTime;
    }

    function formatTime(milliseconds) {
        var hours = Math.floor(milliseconds / 3600000);
        var minutes = Math.floor((milliseconds % 3600000) / 60000);
        var seconds = Math.floor((milliseconds % 60000) / 1000);
        var ms = milliseconds % 1000;
        return (hours < 10 ? "0" + hours : hours) + ":" +
               (minutes < 10 ? "0" + minutes : minutes) + ":" +
               (seconds < 10 ? "0" + seconds : seconds) + "." +
               (ms < 100 ? (ms < 10 ? "00" + ms : "0" + ms) : ms);
    }

    function sendPredefinedQuestion(question) {
        document.getElementById('question-input').value = question;
        document.getElementById('send-button').click();
    }

    function sendRandomPredefinedQuestion(type) {
        var urlMap = {
            '생물 보호': 'biological_protection',
            '수상레저': 'water_leisure',
            '불법': 'illegality',
            '해양오염': 'marine_pollution',
            '피서객 안전': 'safety_vacationers',
            '익수자': 'watery_man',
            '의료지원': 'medical_aid',
            '실종': 'missing',
        };

        var scenarioType = urlMap[type];
        if (!scenarioType) {
            alert('Invalid scenario type');
            return;
        }

        fetch(`/get_scenarios/${scenarioType}/`)
            .then(response => response.json())
            .then(data => {
                var scenarios = data.scenarios;
                if (scenarios.length > 0) {
                    var randomIndex = Math.floor(Math.random() * scenarios.length);
                    var selectedScenario = scenarios[randomIndex];
                    var question = '유형: ' + selectedScenario.scenario_code + ', 상황: ' + selectedScenario.scenario_situation + '시나리오 생성';
                    sendPredefinedQuestion(question);
                } else {
                    alert(type + ' 시나리오가 없습니다.');
                }
            })
            .catch(error => {
                console.error('Error fetching scenarios:', error);
            });
    }

    function handleKeyPress(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    }

    function sendMessage() {
        var question = document.getElementById('question-input').value;
        if (question.trim() === '') {
            alert('질문을 입력하세요.');
            return;
        }

        document.getElementById('loading-spinner').style.display = 'block';

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "chat" %}', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

        xhr.onload = function() {
    // 로딩 스피너 숨기기
    document.getElementById('loading-spinner').style.display = 'none';

    if (xhr.status === 200) {
        var response = JSON.parse(xhr.responseText);
        var chatContent = document.getElementById('chat-content');
        chatContent.innerHTML = ''; // Clear previous chat messages
        var newMessage = document.createElement('div');
        newMessage.classList.add('chat-message');
        newMessage.innerHTML = '<strong>질문:</strong> ' + response.question + '<br>' +
                               '<strong>답변:</strong><br>' +
                               response.answer.replace(/\n/g, "<br>") + '<br>';
        chatContent.appendChild(newMessage);
        chatContent.scrollTop = chatContent.scrollHeight;

        document.getElementById('question-input').value = '';
    } else {
        alert('오류가 발생했습니다.');
    }
};

        xhr.send('question=' + encodeURIComponent(question));
    }
</script>

{% endblock %}
